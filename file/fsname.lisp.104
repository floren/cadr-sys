;;; -*- Mode: Lisp; Package: File-System; Base: 8. -*-

;; This file contains the pathname interface to the local file system.

(DEFFLAVOR LOCAL-FILE-MIXIN () ()
  (:REQUIRED-FLAVORS FS:PATHNAME))

(DEFMETHOD (LOCAL-FILE-MIXIN :OPEN) (PATHNAME &REST OPTIONS)
  (APPLY 'LMFS-OPEN-FILE PATHNAME DIRECTORY NAME TYPE VERSION OPTIONS))

(DEFMETHOD (LOCAL-FILE-MIXIN :DELETE) (&OPTIONAL (ERROR-P T))
  (IDENTIFY-FILE-OPERATION ':DELETE
    (HANDLING-ERRORS ERROR-P
      (OPENING-INPUT-FILE (FILE DIRECTORY NAME TYPE VERSION)
        (LMFS-DELETE-FILE FILE)))))

(DEFMETHOD (LOCAL-FILE-MIXIN :UNDELETABLE-P) () T)

(DEFMETHOD (LOCAL-FILE-MIXIN :UNDELETE) (&OPTIONAL (ERROR-P T))
  (IDENTIFY-FILE-OPERATION ':UNDELETE
    (HANDLING-ERRORS ERROR-P
      (OPENING-INPUT-FILE (FILE DIRECTORY NAME TYPE VERSION)
        (LMFS-UNDELETE-FILE FILE)))))

(DEFMETHOD (LOCAL-FILE-MIXIN :EXPUNGE) (&KEY (ERROR T))
  (IDENTIFY-FILE-OPERATION ':EXPUNGE
    (HANDLING-ERRORS ERROR
      (LMFS-EXPUNGE-DIRECTORY DIRECTORY NAME TYPE VERSION))))

(DEFMETHOD (LOCAL-FILE-MIXIN :DELETE-MULTIPLE-FILES) (ERROR-P PATHNAMES)
  (IDENTIFY-FILE-OPERATION ':DELETE
    (HANDLING-ERRORS ERROR-P
       (LOOP FOR PATHNAME IN PATHNAMES
	     WITH FILES-OF-DIRECTORY-TO-WRITE = NIL
	     DO (OPENING-INPUT-FILE (FILE (PATHNAME-DIRECTORY PATHNAME)
					  (PATHNAME-NAME PATHNAME)
					  (PATHNAME-TYPE PATHNAME)
					  (PATHNAME-VERSION PATHNAME))
		   (LMFS-DELETE-FILE FILE NIL)
		   (LOOP FOR ENTRY IN FILES-OF-DIRECTORY-TO-WRITE
			 WHEN (EQUAL (FILE-DIRECTORY FILE) (FILE-DIRECTORY ENTRY))
			 RETURN NIL
			 FINALLY (PUSH FILE FILES-OF-DIRECTORY-TO-WRITE)))
	     FINALLY
	     (DOLIST (FILE FILES-OF-DIRECTORY-TO-WRITE)
	       (WRITE-DIRECTORY-OF-FILE FILE))))))


(DEFMETHOD (LOCAL-FILE-MIXIN :RENAME) (NEW-NAME &OPTIONAL (ERROR-P T))
  (IDENTIFY-FILE-OPERATION ':RENAME
    (HANDLING-ERRORS ERROR-P
      (OPENING-INPUT-FILE (FILE DIRECTORY NAME TYPE VERSION)
	(LMFS-RENAME-FILE FILE
			  (PATHNAME-DIRECTORY NEW-NAME)
			  (OR (PATHNAME-NAME NEW-NAME) "FOO")
			  (OR (PATHNAME-TYPE NEW-NAME) ':UNSPECIFIC)
			  (PATHNAME-VERSION NEW-NAME))))))

(DEFMETHOD (LOCAL-FILE-MIXIN :DIRECTORY-LIST) (OPTIONS)
  (LMFS-DIRECTORY-LIST SELF HOST DIRECTORY NAME TYPE VERSION OPTIONS))

(DEFMETHOD (LOCAL-FILE-MIXIN :ALL-DIRECTORIES) (OPTIONS)
  (LMFS-ALL-DIRECTORIES HOST (NOT (MEMQ ':NOERROR OPTIONS))))

(DEFMETHOD (LOCAL-FILE-MIXIN :MULTIPLE-FILE-PLISTS) (PATHNAMES OPTIONS)
  "This is a hack to speed up DIRED.
There are no currently meaningful options." OPTIONS
  (IDENTIFY-FILE-OPERATION ':PROPERTIES
    (MAPCAR #'(LAMBDA (PATHNAME)
		(LET ((TPATHNAME (SEND PATHNAME ':TRANSLATED-PATHNAME)))
		  (OPENING-INPUT-FILE (FILE (PATHNAME-DIRECTORY TPATHNAME)
					    (PATHNAME-NAME TPATHNAME)
					    (PATHNAME-TYPE TPATHNAME)
					    (PATHNAME-VERSION TPATHNAME))
		    (IF (NULL FILE)
			(LIST PATHNAME)
		      (LIST* PATHNAME
			     ':TRUENAME (FILE-TRUENAME FILE)
			     (LMFS-FILE-PROPERTIES FILE))))))
	    PATHNAMES)))

(DEFMETHOD (LOCAL-FILE-MIXIN :CHANGE-PROPERTIES) (ERROR-P &REST PLIST)
  (IDENTIFY-FILE-OPERATION ':CHANGE-PROPERTIES
    (HANDLING-ERRORS ERROR-P
      (OPENING-INPUT-FILE (FILE DIRECTORY NAME TYPE VERSION)
	(LMFS-CHANGE-FILE-PROPERTIES FILE PLIST)))))

(DEFMETHOD (LOCAL-FILE-MIXIN :COMPLETE-STRING) (STRING OPTIONS)
  (MULTIPLE-VALUE-BIND (DEV DIR NAM TYP VER)
      (SEND SELF ':PARSE-NAMESTRING HOST STRING)
    (MULTIPLE-VALUE-BIND (NEW-DIRECTORY NEW-NAME NEW-TYPE COMPLETION)
	(LMFS-COMPLETE-PATH (OR DIR DIRECTORY "") (OR NAM "") (OR TYP "")
			    NAME TYPE OPTIONS)
      (VALUES (LM-NAMESTRING HOST (OR DEV DEVICE) NEW-DIRECTORY NEW-NAME NEW-TYPE VER)
	      COMPLETION))))

(DEFMETHOD (LOCAL-FILE-MIXIN :CREATE-DIRECTORY) (&KEY &OPTIONAL (ERROR T))
  (IDENTIFY-FILE-OPERATION ':CREATE-DIRECTORY
    (HANDLING-ERRORS ERROR
      (LMFS-CREATE-DIRECTORY DIRECTORY)
      T)))

(DEFMETHOD (LOCAL-FILE-MIXIN :CREATE-LINK) (TARGET &KEY (ERROR T))
  TARGET
  (HANDLING-ERRORS ERROR
    (LM-SIGNAL-ERROR 'LINKS-NOT-SUPPORTED NIL NIL ':CREATE-LINK)))

;;; The actual local pathname.
(DEFFLAVOR LM-PATHNAME () (LOCAL-FILE-MIXIN LM-PARSING-MIXIN REMOTE-PATHNAME))

;;;This flavor of pathname is not always the right one for its host.
(DEFPROP LM-PATHNAME T PATHNAME-FLAVOR-CHANGES)

; What about :OPEN-STREAMS???

(COMPILE-FLAVOR-METHODS LM-PATHNAME)
