;;; -*- Mode: Lisp; Package: ZWEI; Base: 8.; Patch-File: T -*-
;;; Patch file for ZMail version 53.16
;;; Reason: Usual mail file directory user option.
;;; Written 4/18/84 02:36:35 by RpK,
;;; while running on Lisp Machine One from band 7
;;; with Don't-dump-a-band! Inconsistent (unreleased patches loaded) System 98.44, CADR 3.6, Inconsistent (unreleased patches loaded) ZMail 53.15, MIT-Specific 22.0, microcode 309.



; From file DEFS.LISP PS:<L.ZMAIL> OZ:
#8R ZWEI#:
(COMPILER-LET ((PACKAGE (PKG-FIND-PACKAGE "ZWEI")))
  (COMPILER#:PATCH-SOURCE-FILE "SYS: ZMAIL; DEFS  "

(DEFINE-ZMAIL-USER-OPTION *ZMAIL-USUAL-MAIL-FILE-DIRECTORY* () :PATHNAME-OR-NIL
			  "Directory where most of your mail files live")

))

; From file COMNDS.LISP PS:<L.ZMAIL> OZ:
#8R ZWEI#:
(COMPILER-LET ((PACKAGE (PKG-FIND-PACKAGE "ZWEI")))
  (COMPILER#:PATCH-SOURCE-FILE "SYS: ZMAIL; COMNDS  "

(DEFUN ZMAIL-BUFFER-NAME-FOR-BUFFER-ALIST (ZMAIL-BUFFER)
  (IF (OR (NULL *ZMAIL-USUAL-MAIL-FILE-DIRECTORY*)
	  (NOT (TYPEP ZMAIL-BUFFER 'MAIL-FILE-BUFFER)))
      (ZMAIL-BUFFER-NAME ZMAIL-BUFFER)
    (LET ((PATHNAME (SEND ZMAIL-BUFFER :PATHNAME)))
      (IF (AND (EQ (SEND PATHNAME :HOST) (SEND *ZMAIL-USUAL-MAIL-FILE-DIRECTORY* :HOST))
	       (EQUAL (SEND PATHNAME :DEVICE)
		      (SEND *ZMAIL-USUAL-MAIL-FILE-DIRECTORY* :DEVICE))
	       (EQUAL (SEND PATHNAME :DIRECTORY)
		      (SEND *ZMAIL-USUAL-MAIL-FILE-DIRECTORY* :DIRECTORY)))
	  (SEND PATHNAME :NAME)
	(ZMAIL-BUFFER-NAME ZMAIL-BUFFER)))))

))

; From file COMNDS.LISP PS:<L.ZMAIL> OZ:
#8R ZWEI#:
(COMPILER-LET ((PACKAGE (PKG-FIND-PACKAGE "ZWEI")))
  (COMPILER#:PATCH-SOURCE-FILE "SYS: ZMAIL; COMNDS  "

(DEFUN GET-ZMAIL-BUFFER-ALISTS (&OPTIONAL OTHERS-TOO &AUX MFL TMFL MFL-PATHNAMES)
  (DOLIST (ZMAIL-BUFFER *ZMAIL-BUFFER-LIST*)
    (LET ((ELEM (CONS (ZMAIL-BUFFER-NAME-FOR-BUFFER-ALIST ZMAIL-BUFFER) ZMAIL-BUFFER)))
      (IF (ZMAIL-BUFFER-DISK-P ZMAIL-BUFFER)
	  (PUSH ELEM MFL)
	  (PUSH ELEM TMFL))))
  (SETQ MFL (SORTCAR MFL #'STRING-LESSP)
	TMFL (SORTCAR TMFL #'STRING-LESSP))
  (SETQ MFL-PATHNAMES
	(MAPCAR 'BUFFER-PATHNAME
		*ZMAIL-BUFFER-LIST*))
  (IF (FIND-IF 'STRINGP *OTHER-MAIL-FILE-NAMES*)
      (SETQ *OTHER-MAIL-FILE-NAMES*
	    (MAPCAR 'PARSE-NAMESTRING *OTHER-MAIL-FILE-NAMES*)))
  (AND OTHERS-TOO
       (DOLIST (FILE-NAME (SORT *OTHER-MAIL-FILE-NAMES* 'STRING-LESSP))
	 (OR (MEMBER (SEND FILE-NAME ':NEW-VERSION :NEWEST) MFL-PATHNAMES)
	     (SETQ MFL (NCONC MFL (NCONS (CONS FILE-NAME FILE-NAME)))))))
  (VALUES MFL TMFL))

))
